generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ActivityLog {
  id              String    @id @default(uuid())
  deviceId        String    @unique @map("device_id")
  lastAiQuery     DateTime? @map("last_ai_query")
  lastFileSync    DateTime? @map("last_file_sync")
  lastChatMessage DateTime? @map("last_chat_message")
  device          Device    @relation(fields: [deviceId], references: [id])

  @@map("activity_logs")
}

model AIChunk {
  id        String   @id @default(uuid())
  queryId   String   @unique @map("query_id")
  deviceId  String   @map("device_id")
  chunks    String[]
  cursor    Int      @default(0)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([expiresAt])
  @@index([queryId])
  @@map("ai_chunks")
}

model AIConfig {
  id          String     @id @default(uuid())
  deviceId    String     @unique @map("device_id")
  provider    AIProvider @default(OPENAI)
  model       String     @default("gpt-4o-mini")
  maxChars    Int        @default(2500) @map("max_chars")
  temperature Float      @default(0.3)
  apiKey      String?    @map("api_key")
  device      Device     @relation(fields: [deviceId], references: [id])

  @@map("ai_configs")
}

model BindCode {
  id        String   @id @default(uuid())
  code      String   @unique
  deviceId  String   @map("device_id")
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  device    Device   @relation(fields: [deviceId], references: [id])

  @@index([code, expiresAt])
  @@map("bind_codes")
}

model ChatMessage {
  id        String     @id @default(uuid())
  deviceId  String     @map("device_id")
  sender    SenderType
  content   String     @db.VarChar(2500)
  createdAt DateTime   @default(now()) @map("created_at")
  device    Device     @relation(fields: [deviceId], references: [id])

  @@index([deviceId, createdAt])
  @@map("chat_messages")
}

model Device {
  id              String        @id @default(uuid())
  deviceId        String        @unique @map("device_id")
  ownerId         String?       @map("owner_id")
  macAddress      String        @map("mac_address")
  firmwareVersion String        @default("1.0.0") @map("firmware_version")
  lastSeen        DateTime?     @map("last_seen")
  online          Boolean       @default(false)
  batteryPercent  Int           @default(100) @map("battery_percent")
  powerMode       PowerMode     @default(NORMAL) @map("power_mode")
  textSize        TextSize      @default(NORMAL) @map("text_size")
  keyboard        KeyboardType  @default(QWERTY)
  screenTimeout   Int           @default(30) @map("screen_timeout")
  wifiSsid        String?       @map("wifi_ssid")
  freeStorage     Int?          @map("free_storage")
  freeRam         Int?          @map("free_ram")
  deviceToken     String?       @map("device_token")
  tokenRevoked    Boolean       @default(false) @map("token_revoked")
  createdAt       DateTime      @default(now()) @map("created_at")
  pendingToken    String?       @map("pending_token")
  activityLog     ActivityLog?
  aiConfig        AIConfig?
  bindCodes       BindCode[]
  chatMessages    ChatMessage[]
  owner           User?         @relation(fields: [ownerId], references: [id])
  file            File?
  otaJobs         OTAJob[]

  @@map("devices")
}

model File {
  id        String   @id @default(uuid())
  deviceId  String   @unique @map("device_id")
  content   String   @db.VarChar(4000)
  charCount Int      @map("char_count")
  updatedAt DateTime @map("updated_at")
  device    Device   @relation(fields: [deviceId], references: [id])

  @@map("files")
}

model Firmware {
  id          String   @id @default(uuid())
  version     String   @unique
  storagePath String   @map("storage_path")
  checksum    String
  fileSize    Int      @map("file_size")
  notes       String?
  createdAt   DateTime @default(now()) @map("created_at")
  otaJobs     OTAJob[]

  @@map("firmware")
}

model OTAJob {
  id         String    @id @default(uuid())
  deviceId   String    @map("device_id")
  firmwareId String    @map("firmware_id")
  status     OTAStatus @default(PENDING)
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @map("updated_at")
  device     Device    @relation(fields: [deviceId], references: [id])
  firmware   Firmware  @relation(fields: [firmwareId], references: [id])

  @@index([deviceId, status])
  @@map("ota_jobs")
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  createdAt    DateTime @default(now()) @map("created_at")
  devices      Device[]

  @@map("users")
}

enum AIProvider {
  OPENAI
  ANTHROPIC
  GEMINI
  DEEPSEEK
  PERPLEXITY
  GROQ
  OPENROUTER
}

enum KeyboardType {
  QWERTY
  T9
}

enum OTAStatus {
  PENDING
  DOWNLOADING
  SUCCESS
  FAILED
  ROLLED_BACK
}

enum PowerMode {
  NORMAL
  LOW
}

enum SenderType {
  DEVICE
  WEB
}

enum TextSize {
  SMALL
  NORMAL
  LARGE
}
